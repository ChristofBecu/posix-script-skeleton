#!/bin/sh
# POSIX entry point

set -u

# Get tool name
_tool_name=$(basename "$0")

# Find and source bootstrap
_script_dir=$(CDPATH= cd -- "$(dirname -- "$0")/.." && pwd)

# Try source dir first, then user install, then system install
if [ -f "$_script_dir/lib/bootstrap.sh" ] && [ -f "$_script_dir/config" ]; then
    . "$_script_dir/lib/bootstrap.sh" && bootstrap_init "$_script_dir"
elif [ -f "$HOME/.local/lib/$_tool_name/bootstrap.sh" ]; then
    . "$HOME/.local/lib/$_tool_name/bootstrap.sh" && bootstrap_init
elif [ -f "/etc/$_tool_name/lib/bootstrap.sh" ]; then
    . "/etc/$_tool_name/lib/bootstrap.sh" && bootstrap_init
else
    printf 'Error: Cannot find bootstrap\n' >&2 && exit 1
fi

# Load modules
. "$LIB_DIR/core.sh"
. "$LIB_DIR/io.sh"
. "$LIB_DIR/state.sh"
. "$LIB_DIR/lock.sh"

# Execute
parse_args "$@"
lock_acquire
load_state
run
save_state
lock_release
