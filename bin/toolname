#!/bin/sh
# POSIX entry point

# Fail fast on unset vars
set -u

# Resolve base directory (POSIX-safe)
BASEDIR=$(CDPATH= cd -- "$(dirname -- "$0")/.." && pwd)

# Load configuration
if [ -f "$BASEDIR/config" ]; then
    . "$BASEDIR/config"
fi

# Load modules
. "$BASEDIR/lib/core.sh"
. "$BASEDIR/lib/io.sh"
. "$BASEDIR/lib/state.sh"
. "$BASEDIR/lib/lock.sh"

# Parse arguments first (to set LOCK_SCOPE before acquiring lock)
parse_args "$@"

# Acquire lock (will use dynamic path based on LOCK_SCOPE)
lock_acquire

# Run main (skip parse_args since already done)
load_state
run
save_state

# Release lock
lock_release
